<app-navbar></app-navbar>
<div class="container-fluid mt-4">
  <div class="search-bar card">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <div class="input-group">
            <label class="input-group-text" for="search-by"><i class="fas fa-user"></i></label>
            <input type="text" class="form-control" placeholder="Nom du chauffeur" id="search-by" aria-label="Search by name" [(ngModel)]="searchName" (input)="filterContent()">
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <label class="input-group-text" for="phone-search"><i class="fas fa-phone"></i></label>
            <input type="text" class="form-control" placeholder="N° de téléphone" id="phone-search" aria-label="Search by phone" [(ngModel)]="searchPhone" (input)="filterContent()">
            <button class="btn btn-primary" type="button" (click)="searchByPhone()" aria-label="Search" [disabled]="isSearchingPhone">
              <i *ngIf="!isSearchingPhone" class="fas fa-search"></i>
              <i *ngIf="isSearchingPhone" class="fas fa-spinner fa-spin"></i>
            </button>
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group">
            <label class="input-group-text" for="email-search"><i class="fas fa-envelope"></i></label>
            <input type="email" class="form-control" placeholder="E-mail" id="email-search" aria-label="Search by email" [(ngModel)]="searchEmail" (input)="filterContent()">
            <button class="btn btn-primary" type="button" (click)="searchByEmail()" aria-label="Search" [disabled]="isSearchingEmail">
              <i *ngIf="!isSearchingEmail" class="fas fa-search"></i>
              <i *ngIf="isSearchingEmail" class="fas fa-spinner fa-spin"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
      <div class="profile-sidebar card sticky-top">
        <div class="card-body text-center">
          <div class="profile-avatar animate__animated animate__fadeIn">{{ driver.initial }}</div>
          <h4 class="card-title">{{ driver.name }}</h4>
          <p class="status badge" [ngClass]="{'bg-success': driver.status === 'Actif', 'bg-warning': driver.status === 'Inactif'}">{{ driver.status }}</p>
          <hr>
          <div class="info-block">
            <p><strong>Ville:</strong> {{ driver.city }}</p>
            <p><strong>Break:</strong> {{ driver.break }}</p>
            <p><strong>ID:</strong> {{ driver.id }}</p>
            <p><strong>CB1:</strong> {{ driver.cb1 }} <br><strong>CB2:</strong> {{ driver.cb2 }}</p>
          </div>
          <div class="mt-3">
            <img [src]="driver.mapImageUrl" alt="Map" class="img-fluid rounded animate__animated animate__zoomIn">
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="content-area card">
        <div class="card-body">
          <ul class="nav nav-pills mb-4" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'info'" (click)="selectTab('info')" type="button" role="tab" data-bs-toggle="tooltip" title="Driver Information"><i class="fas fa-info-circle"></i> Informations</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'update'" (click)="selectTab('update')" type="button" role="tab" data-bs-toggle="tooltip" title="Update Profile"><i class="fas fa-edit"></i> Mise à jour</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'courses'" (click)="selectTab('courses')" type="button" role="tab" data-bs-toggle="tooltip" title="Ride History"><i class="fas fa-route"></i> Courses</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'docs'" (click)="selectTab('docs')" type="button" role="tab" data-bs-toggle="tooltip" title="Documents"><i class="fas fa-file-alt"></i> Documents</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'payments'" (click)="selectTab('payments')" type="button" role="tab" data-bs-toggle="tooltip" title="Payments"><i class="fas fa-credit-card"></i> Paiements</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeTab === 'history'" (click)="selectTab('history')" type="button" role="tab" data-bs-toggle="tooltip" title="Activity History"><i class="fas fa-history"></i> Historique</button>
            </li>
          </ul>

          <div class="tab-content animate__animated animate__fadeIn">
            <div *ngIf="activeTab === 'info'" class="tab-pane fade" [class.show]="activeTab === 'info'" [class.active]="activeTab === 'info'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-building"></i> Informations de Société</h5>
                  <div class="row">
                    <div class="col-md-6"><p><span class="info-label">Siren/Siret:</span> {{ company.siren }}</p></div>
                    <div class="col-md-6"><p><span class="info-label">Nom de Société:</span> {{ company.name }}</p></div>
                    <div class="col-md-6"><p><span class="info-label">IBAN:</span> {{ company.iban }}</p></div>
                    <div class="col-md-6"><p><span class="info-label">TVA:</span> {{ company.vat }}</p></div>
                    <div class="col-md-6"><p><span class="info-label">Lien de mise à jour:</span> <a href="#" aria-label="Update company information" (click)="selectTab('update')">Mettre à jour</a></p></div>
                    <div class="col-md-6"><p><span class="info-label">Adresse:</span> {{ company.address }}</p></div>
                  </div>
                </div>
              </div>
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-car"></i> Véhicule</h5>
                  <div class="row">
                    <div class="col-md-4"><p><span class="info-label">Année de voiture:</span> {{ vehicle.year }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Modèle de voiture:</span> {{ vehicle.model }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Immatriculation:</span> {{ vehicle.registration }}</p></div>
                  </div>
                </div>
              </div>
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-info"></i> Informations</h5>
                  <div class="row">
                    <div class="col-md-4"><p><span class="info-label">Total de courses:</span> {{ info.totalRides }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Date de naissance:</span> {{ info.birthDate }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Raison de état:</span> {{ info.statusReason }}</p></div>
                  </div>
                </div>
              </div>
              <div class="info-section card">
                <div class="card-body">
                  <h5><i class="fas fa-mobile-alt"></i> Informations de l'Application <span class="badge bg-secondary">Notif de test</span></h5>
                  <div class="row">
                    <div class="col-md-4"><p><span class="info-label">Date d'inscription:</span> {{ appInfo.registrationDate }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Dernière ouverture:</span> {{ appInfo.lastOpened }}</p></div>
                    <div class="col-md-4"><p><span class="info-label">Position actuelle:</span> {{ appInfo.currentPosition }}</p></div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="activeTab === 'update'" class="tab-pane fade" [class.show]="activeTab === 'update'" [class.active]="activeTab === 'update'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-edit"></i> Mettre à jour le profil</h5>
                  <form [formGroup]="profileForm" (ngSubmit)="updateProfile()">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="update-name" class="form-label">Nom du chauffeur</label>
                        <input type="text" class="form-control" id="update-name" formControlName="name" placeholder="Nom du chauffeur" [ngClass]="{'is-invalid': profileForm.get('name')?.invalid && profileForm.get('name')?.touched}">
                        <div *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched" class="invalid-feedback">
                          Le nom est requis.
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="update-city" class="form-label">Ville</label>
                        <input type="text" class="form-control" id="update-city" formControlName="city" placeholder="Ville" [ngClass]="{'is-invalid': profileForm.get('city')?.invalid && profileForm.get('city')?.touched}">
                        <div *ngIf="profileForm.get('city')?.invalid && profileForm.get('city')?.touched" class="invalid-feedback">
                          La ville est requise.
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="update-status" class="form-label">Statut</label>
                        <select class="form-control" id="update-status" formControlName="status" [ngClass]="{'is-invalid': profileForm.get('status')?.invalid && profileForm.get('status')?.touched}">
                          <option value="Actif">Actif</option>
                          <option value="Inactif">Inactif</option>
                        </select>
                        <div *ngIf="profileForm.get('status')?.invalid && profileForm.get('status')?.touched" class="invalid-feedback">
                          Le statut est requis.
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="update-cb1" class="form-label">CB1</label>
                        <input type="text" class="form-control" id="update-cb1" formControlName="cb1" placeholder="CB1" [ngClass]="{'is-invalid': profileForm.get('cb1')?.invalid && profileForm.get('cb1')?.touched}">
                        <div *ngIf="profileForm.get('cb1')?.invalid && profileForm.get('cb1')?.touched" class="invalid-feedback">
                          CB1 est requis.
                        </div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || isUpdating">Mettre à jour <i *ngIf="isUpdating" class="fas fa-spinner fa-spin ms-2"></i></button>
                  </form>
                </div>
              </div>
            </div>
            <div *ngIf="activeTab === 'courses'" class="tab-pane fade" [class.show]="activeTab === 'courses'" [class.active]="activeTab === 'courses'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-route"></i> Historique des courses</h5>
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Départ</th>
                        <th>Destination</th>
                        <th>Distance</th>
                        <th>Tarif</th>
                        <th>Statut</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let course of filteredCourses" class="animate__animated animate__fadeInUp">
                        <td>{{ course.date }}</td>
                        <td>{{ course.start }}</td>
                        <td>{{ course.end }}</td>
                        <td>{{ course.distance }} km</td>
                        <td>{{ course.fare }} €</td>
                        <td><span class="badge" [ngClass]="{'bg-success': course.status === 'Terminé', 'bg-warning': course.status === 'Annulé'}">{{ course.status }}</span></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div *ngIf="activeTab === 'docs'" class="tab-pane fade" [class.show]="activeTab === 'docs'" [class.active]="activeTab === 'docs'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-file-alt"></i> Documents</h5>
                  <ul class="list-group">
                    <li *ngFor="let doc of filteredDocuments" class="list-group-item d-flex justify-content-between align-items-center animate__animated animate__fadeInUp">
                      {{ doc.name }}
                      <div>
                        <span class="badge" [ngClass]="{'bg-success': doc.status === 'Validé', 'bg-danger': doc.status === 'Expiré'}">{{ doc.status }}</span>
                        <button class="btn btn-sm btn-primary ms-2" (click)="viewDocument(doc.id)" aria-label="Voir le document">Voir</button>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <div *ngIf="activeTab === 'payments'" class="tab-pane fade" [class.show]="activeTab === 'payments'" [class.active]="activeTab === 'payments'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-credit-card"></i> Historique des paiements</h5>
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Méthode</th>
                        <th>Statut</th>
                        <th>Facture</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let payment of filteredPayments" class="animate__animated animate__fadeInUp">
                        <td>{{ payment.date }}</td>
                        <td>{{ payment.amount }} €</td>
                        <td>{{ payment.method }}</td>
                        <td><span class="badge" [ngClass]="{'bg-success': payment.status === 'Payé', 'bg-warning': payment.status === 'En attente'}">{{ payment.status }}</span></td>
                        <td><button class="btn btn-sm btn-primary" (click)="viewInvoice(payment.id)" aria-label="Voir la facture">Voir</button></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div *ngIf="activeTab === 'history'" class="tab-pane fade" [class.show]="activeTab === 'history'" [class.active]="activeTab === 'history'">
              <div class="info-section card mb-3">
                <div class="card-body">
                  <h5><i class="fas fa-history"></i> Historique d'activité</h5>
                  <ul class="list-group">
                    <li *ngFor="let activity of filteredActivityHistory" class="list-group-item animate__animated animate__fadeInUp">
                      <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ activity.action }}</h6>
                        <small>{{ activity.date }}</small>
                      </div>
                      <p class="mb-1">{{ activity.description }}</p>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirmer les modifications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Voulez-vous vraiment enregistrer les modifications du profil ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="confirmUpdate()">Confirmer</button>
      </div>
    </div>
  </div>
</div>